name: Lint & Deploy

on:
  push:
    branches:
      - main  # mainãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ

jobs:
  lint-and-deploy:
    runs-on: ubuntu-latest  # GitHubã®ä»®æƒ³ç’°å¢ƒï¼ˆLinuxï¼‰ã§å®Ÿè¡Œ

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install
        working-directory: ./public  # package.json ã®ã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š

      - name: Lintãƒã‚§ãƒƒã‚¯
        run: npm run lint || exit 1
        working-directory: ./public # Lintã‚‚åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œ

      - name: å¤±æ•—ã—ãŸå ´åˆã€Slackã«é€šçŸ¥
        if: failure()  # ç›´å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ã—ãŸå ´åˆã«å®Ÿè¡Œ
        run: |
          curl -X POST -H 'Content-type: application/json' --data \
          '{
            "text": "ğŸš¨ *Lintã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ* ğŸš¨\nãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}\nãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}\nå®Ÿè¡Œè€…: ${{ github.actor }}\nè©³ç´°: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }' ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆè¨­å®š
        run: nohup npm run server & # ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
        working-directory: ./public

      - name: Cypressãƒã‚§ãƒƒã‚¯
        uses: cypress-io/github-action@v2
        with:
          start: false  # Cypresså†…ã§ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã—ãªã„è¨­å®š
          wait-on: 'http://localhost:3000'  # ã‚µãƒ¼ãƒãƒ¼ãŒç«‹ã¡ä¸ŠãŒã‚‹ã¾ã§å¾…æ©Ÿ

      - name: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®ã‚µãƒ¼ãƒã‚’åœæ­¢
        run: kill $(ps aux | grep 'npm run dev' | awk '{print $1}')  # ã‚µãƒ¼ãƒãƒ¼åœæ­¢

      - name: SSHéµã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/github-actions
          chmod 600 ~/.ssh/github-actions
          ssh-keyscan -p 30032 wc5.mj-star.jp >> ~/.ssh/known_hosts

      - name: Webã‚µãƒ¼ãƒã§ãƒ‡ãƒ—ãƒ­ã‚¤
        if: success()  # LintãŒæˆåŠŸã—ãŸã‚‰å®Ÿè¡Œ
        run: |
          ssh -i ~/.ssh/github-actions -p 30032 deployer@wc5.mj-star.jp \
          "cd /home/deployer/sites/autotest-cicd-repo.mj-star.jp && git pull origin main"
